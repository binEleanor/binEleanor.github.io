---
layout: post
title:  "实体识别和关系抽取"
date:   2018-08-02
excerpt: "本文主要介绍命名实体识别和关系抽取，命名实体识别着重介绍条件随机场"
tag:
- markdown 
- syntax
- sample
- test
- jekyll
comments: true
---

### 实体识别和关系抽取

实体识别又称命名实体识别，即对给定的一段文本，获取文本中的实体，对实体类型进行标注，如对人名，地名，时间，机构名等进行标注。

命名实体识别早期一般都是基于规则（正则表达式提取）等进行标注，然而该方法严格依赖于特定领域，对于不同的领域其可能由于规则不一致导致无法泛化模型。

传统公认比较好的命名实体识别处理方法是条件随机场（https://spaces.ac.cn/archives/5542），给定一组输入随机变量条件下另一组输入随机变量的条件概率分布模型，其输出端显示地考虑了上下文的关联。

条件随机场其本质可以理解成分类问题，

序列标注模型：给定一段文本，标注出文本中每个字属于实体类型值域的哪个类型。

如:

> 对于给定文本 :
>
> "2019年8月7日，张三峰在图书馆看书"
>
> 实体类型：S= [time, per, pos] * [B, I, E] U {O}, B, I, E分别表示开始位置，中间位置，结束位置， O表示不是我们关心的实体类型。
>
> 序列标注的结果:
>
>  [B_time, I_time, I_time, I_time,I_time, I_time, I_time,I_time, E_time, O, B_per, I_per, E_per, O, B_pos, I_pos, O_pos, O, O]

### 条件随机场

假设给定的文本有$n$个字，实体类型有$k$种，则每个字都$k$种可选择的空间，按照序列标注模型的架构，我们需要对每个字都标注出其类型，是$n$个$k$分类问题。

条件随机场，将这$n$个$k$分类问题建模成路径问题，从第一个字出发到最后一个字所有可能的路径$k^n$，那么对于目标序列标注结果，一定是这$k^n$个路径中的一条。

> 条件随机场的主要计算条件概率：
>
> $p(y|x), y=(y_1, ..., y_n), x=(x_1, ..., x_n)$

回顾一下Logistic回归模型：

> Logistic模型：$$h_{\theta}=\frac{1}{1+e^{-\theta^{T}x}}$$
>
> 几率：$$\frac{p}{1-p}$$，几率表示事件发生的概率与不发生概率的比值
>
> 对数线性模型：$$log{\frac{p}{1-p}}=log{\frac{h_{\theta}}{1-h_{\theta}}}=\theta^{T}x$$

假设$$F_j(x,y)$$是序列标注模型的第$j$个特征函数，那么对于所有的特征，其特征得分总和为$$\sum_jF_j(x,y)$$，类比于上述对数线性模型，对该特征函数求指数可求得概率：

> $$P(y|x)=\frac{1}{Z(x,w)}exp(\sum_jF_j(x,y))$$
>
> $$Z(x,w) = \sum_yexp(\sum_jF_j(x,y))$$表示归一化因子

条件随机场的目标函数转变成如下形式：

> $y^{*}=argmax_yP(y|x, w)= argmax_y \sum_jw_jF_j(x, y)$

基于统计学习方法主要存在三类问题：

1.基于参数$w$，计算概率$p$；

2.基于参数$w$，计算目标值$y$，预测问题（例如维特比算法）；

3.基于给定样本，计算参数$w$，学习问题.

假设句子$x$的第$j$个特征由若干个子/次特征$f_j(y_{i-1}, y_i, x,i)$组成，$f_j$依赖或者部分依赖当前整个句子，$y_{i-1},y_{i}$分别表示第$i-1,i$个词性，$i$表示当前词在句子中的位置，那么

$$F_j(x, y)=\sum_{i}f_j(y_{i-1}, y_i, x,i)$$

对于上述求条件概率的式子，求归一化因子的时候，$j$的数量可以是无限大的，记住这里的$j$表示所有可能的特征，假设就词性标注而言，前缀/后缀/标点符号等都可以作为其特征函数。一般不能将每个词看作是相互独立的的预测模型可以称之为结构化预测。

 $y^{*}=argmax_yP(y|x, w)= argmax_y \sum_jw_jF_j(x, y)$

$$y* = argmax_y \sum_jw_jF_j(x, y)=argmax_y\sum_jw_j\sum_if(y_{i-1},y_{i},x,i)$$



> $$
> \begin{align}
> y* &= argmax_y \sum_jw_jF_j(x, y)=argmax_y\sum_jw_j\sum_if(y_{i-1},y_{i},x,i) \\
> &=argmax_y\sum_i\sum_jw_jf(y_{i-1},y_{i},x,i) \\
> &=argmax_y\sum_ig_j(y_{i-1},y_{i}), 其中g_j(y_{i-1}, y_i) = \sum_jw_j f(y_{i-1}, y_i, x, i)
> \end{align}
> $$

使得直接作用于次特征，$g_j(y_{i-1}, y_i)$就是第$j$个特征下的状态转移矩阵，上一个词被标注为是$y_{i-1}$的情况下下一个词是$y_i$的得分。

利用前向概率选择最大的标记序列，$\alpha_k(v)$表示第$k$个词标记为$v$的最大的分值，得分值归一化后即为概率值：
$$
\begin{align}
\alpha_k(v) = max_{y_1, y_2, ..., y_{k-1}}(\sum_{i=1}^{k-1}g_i(y_{i-1},y_{i})+g_k(y_{k-1}, v))
\end{align}
$$
可以得到递推公式：
$$
\begin{align}
\alpha_k(v)=max_{y_{k-1}}(\alpha_{k-1}(y_{k-1})+g_k(y_{k-1}, v))
\end{align}
$$
假设句子包含的单词数目为$n$，标记数目为$k$，则时间复杂度为$O(k^2n)$

归一化因子的计算：
$$
\begin{align}
Z(x, w) &=\sum_yexp(\sum_jw_jF(x, y)) \\
&=\sum_y exp \sum_i g_j(y_{i-1}, y_i) \\
&=\sum_y \prod_i exp(g_j(y_{i-1}, y_i)
\end{align}
$$
令$M_t(u,v)=exp(g_t(u,v))$, 
$$
\begin{align}
M_{123}(start,v) &= \sum_qM_{1,2}(start, q)M_3(q, v)\\
&=\sum_q\sum_rM_1(start, r)M_2(r,q)M_3(q, v)
\end{align}
$$
从而根据上述式子：
$$
\begin{align}
M_{12,...,n}(start,stop) &= \sum_{y_1,y_2,...,y_n}M(start,y_1)M(y_1,y_2)...M(y_{n-1}, y_n)
\end{align}
$$
时间复杂度变成了$O(k^3n)$

原来的求概率的公式就变成了如下形式：
$$
\begin{align}
P(y|x) = \frac{1}{Z(x,w)}\sum_jw_jF_j(x,y) 
\end{align}
\$$
$$
\begin{align}
logP(y|x) = -logZ(x,w)+\sum_jw_jF_j(x, y)
\end{align}
$$

$$
logP(y|x)对w_j求偏导，使用梯度上升的方法进行模型求解
$$

###关系抽取的两大类方法

1. 先识别出给定文本中的实体，两两匹配实体，建立实体对，为实体对预测关系；

   优点：模型建立容易，可以独立训练两个模型；

   缺点：忽略了关系抽取过程中实体与实体的关系，且会存在错误级联的现象，一旦实体预测错误，那么关系预测100%会出错，且一个实体影响的不仅是一个三元组的预测准确性，而是与之相关的所有三元组的预测准确性。

2. 联合学习，指的是不单独训练两个模型，而是将之前两个独立的网络模型进行融合，使其能够共享词嵌入层信息，建立端到端的模型架构，对于输入数据直接输出他们的关系三元组。

   《Joint Entity and Relation Extraction Based on A Hybrid Neural Network》

   对于输入的句子共享词嵌入层，使用双向LSTM对输入句子进行编码，然后使用一个LSTM进行命名实体识别和一个CNN来进行关系分类。关系分类的时候，先对之前的抽取出的实体进行两两配对，然后对配对的实体进行关系分类。

3. 《Joint Extraction of Entities and Relations Based on a Novel Tagging Scheme》一种新的标注策略：

   具体标注主要包括三个部分：

   （1）位置信息：实体开始，实体结束，实体中间部分，单个实体 * {实体类型1， 实体类型2， 实体类型3，...}；

   （2）关系类型：关系类型1，关系类型2，关系类型3，...

   （3）实体角色信息：实体1， 实体2（只要不是实体关系三元组的词全部标注为O）

   根据实体位置信息可以找出完整的实体，根据实体角色信息可以获取实体对关系的第一个实体和第二个实体，根据关系类型可以得到实体对之间的关系，综上所述可以建立一个端到端的网络模型取获取三元组，整个该任务变成了序列标注问题。

   该方法无法解决一个问题：实体在不同的三元组中可能有不同的数据类型，然而该标注方法是无法做到在一个句子中给同一个实体标注成两个实体类型的。

参考博客：https://www.cnblogs.com/robert-dlut/p/7710735.html

